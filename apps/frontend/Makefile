.PHONY: deploy build-local deploy-all deploy-prod deploy-dev help install-node-remote verify-ssh-key

# PEM í‚¤ íŒŒì¼ ê²½ë¡œ
PEM_KEY ?= .ssh/ktb-14.pem
SSH_USER ?= ubuntu

# ë°°í¬ ëŒ€ìƒ ì„œë²„ ì„¤ì •
# í˜•ì‹: ìŠ¤í˜ì´ìŠ¤ë¡œ êµ¬ë¶„ëœ IP ì£¼ì†Œ ëª©ë¡
# ì‚¬ìš©ë²•: make deploy-prod DEPLOY_SERVERS="ip1 ip2 ip3"
DEPLOY_SERVERS ?= 3.36.118.176 3.38.209.209
DEV_SERVER ?=

# ì‹¤ì œ ë°°í¬í•  ì„œë²„ ëª©ë¡ (SERVERS ë³€ìˆ˜ê°€ ì œê³µë˜ë©´ ìš°ì„  ì‚¬ìš©)
SERVERS ?= $(DEPLOY_SERVERS)

# ë°°í¬ ê²½ë¡œ
DEPLOY_PATH ?= /home/ubuntu/ktb-chat-frontend

# SSH ë° RSYNC ì˜µì…˜
SSH_OPTS := -i $(PEM_KEY) -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
RSYNC_OPTS := -avz --delete -e "ssh $(SSH_OPTS)"

# ë„ì›€ë§
help:
	@echo "ğŸ“– ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo ""
	@echo "  make build-local          - ë¡œì»¬ì—ì„œ í”„ë¡œë•ì…˜ ë¹Œë“œ"
	@echo "  make deploy              - ê¸°ë³¸ ì„œë²„ì— ë³‘ë ¬ ë°°í¬ (DEPLOY_SERVERS)"
	@echo "  make deploy-prod         - í”„ë¡œë•ì…˜ ì„œë²„ì— ë³‘ë ¬ ë°°í¬"
	@echo "  make deploy-dev          - ê°œë°œ ì„œë²„ì— ë³‘ë ¬ ë°°í¬"
	@echo "  make deploy-all          - ëª¨ë“  ì„œë²„ì— ë³‘ë ¬ ë°°í¬ (DEPLOY_SERVERS + DEV_SERVER)"
	@echo "  make install-node-remote - ì›ê²© ì„œë²„ì— Node.js/npm ì„¤ì¹˜"
	@echo ""
	@echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜:"
	@echo "  PEM_KEY=.ssh/ktb-14.pem             - SSH PEM í‚¤ íŒŒì¼ ê²½ë¡œ"
	@echo "  SSH_USER=ubuntu                     - SSH ì‚¬ìš©ìëª…"
	@echo "  DEPLOY_SERVERS=3.36.118.176         - ë°°í¬í•  ì„œë²„ IP (ìŠ¤í˜ì´ìŠ¤ë¡œ êµ¬ë¶„)"
	@echo "  DEV_SERVER=                         - ê°œë°œ ì„œë²„ IP (ìŠ¤í˜ì´ìŠ¤ë¡œ êµ¬ë¶„)"
	@echo "  DEPLOY_PATH=/home/ubuntu/...        - ë°°í¬ ê²½ë¡œ"
	@echo ""
	@echo "ğŸ“ ì˜ˆì‹œ:"
	@echo "  make deploy-prod                                    - ê¸°ë³¸ ì„œë²„ì— ë°°í¬ (Node.js ìë™ ì„¤ì¹˜)"
	@echo "  make deploy-prod DEPLOY_SERVERS=\"ip1 ip2 ip3\"       - ì—¬ëŸ¬ ì„œë²„ì— ë³‘ë ¬ ë°°í¬"
	@echo "  make deploy-dev DEV_SERVER=\"ip1 ip2\"                - ê°œë°œ ì„œë²„ ì—¬ëŸ¬ ê°œì— ë°°í¬"
	@echo "  make deploy-all DEPLOY_SERVERS=\"ip1 ip2\" DEV_SERVER=\"ip3 ip4\"  - ëª¨ë“  ì„œë²„ì— ë°°í¬"
	@echo "  make install-node-remote DEPLOY_SERVERS=\"ip1 ip2\"   - ìˆ˜ë™ Node.js ì„¤ì¹˜"
	@echo "  make deploy PEM_KEY=.ssh/my-key.pem                 - ì»¤ìŠ¤í…€ SSH í‚¤ ì‚¬ìš©"

# PEM í‚¤ íŒŒì¼ ê¶Œí•œ ì²´í¬ ë° ì„¤ì •
check-pem:
	@if [ ! -f "$(PEM_KEY)" ]; then \
		echo "âŒ PEM í‚¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $(PEM_KEY)"; \
		echo "ğŸ’¡ ssh ë””ë ‰í† ë¦¬ì— PEM í‚¤ë¥¼ ë„£ì–´ì£¼ì„¸ìš”."; \
		exit 1; \
	fi
	@chmod 400 $(PEM_KEY) 2>/dev/null || true
	@echo "âœ… PEM í‚¤ í™•ì¸ ì™„ë£Œ: $(PEM_KEY)"

# SSH í‚¤ ì¡´ì¬ í™•ì¸ (ë°±ì—”ë“œì™€ í˜¸í™˜)
verify-ssh-key: check-pem

# ì›ê²© ì„œë²„ì— Node.js ë° npm ì„¤ì¹˜
install-node-remote: verify-ssh-key
	@echo "ğŸ“¦ Installing Node.js and npm on remote servers..."
	@echo "   Using SSH key: $(PEM_KEY)"
	@echo "   Target servers: $(SERVERS)"
	@echo ""
	@for server in $(SERVERS); do \
		echo "  â†’ Installing Node.js on $$server..."; \
		ssh $(SSH_OPTS) $(SSH_USER)@$$server "\
			echo '  [$$server] Checking Node.js installation...' && \
			if command -v node &> /dev/null; then \
				echo '  [$$server] Node.js already installed: '\$$(node -v); \
			else \
				echo '  [$$server] Node.js not found, installing...' && \
				curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - && \
				sudo apt-get install -y nodejs && \
				echo '  [$$server] Node.js installed: '\$$(node -v) && \
				echo '  [$$server] npm installed: '\$$(npm -v); \
			fi" && \
		echo "  âœ… $$server Node.js setup completed" || \
		echo "  âŒ $$server Node.js setup failed"; \
	done
	@echo ""
	@echo "âœ… All Node.js installations completed!"

# ë¡œì»¬ì—ì„œ í”„ë¡œë•ì…˜ ë¹Œë“œ
build-local:
	@echo "ğŸ—ï¸  Building locally..."
	npm run build:production
	@echo "âœ… Local build completed!"

# ë‹¨ì¼ ì„œë²„ ë°°í¬ í•¨ìˆ˜ (ë³‘ë ¬ ì‹¤í–‰ìš©)
# ì¸ì: $$server (ì„œë²„ IP ì£¼ì†Œ)
define deploy_single_server
	echo ""; \
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
	echo "â†’ ë°°í¬ ëŒ€ìƒ: $$server"; \
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
	echo "  ğŸ“¡ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸..."; \
	ssh $(SSH_OPTS) $(SSH_USER)@$$server "echo 'âœ… ì—°ê²° ì„±ê³µ'" || (echo "âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: $$server" && exit 1); \
	echo "  ğŸ” Node.js í™•ì¸ ë° ì„¤ì¹˜..."; \
	ssh $(SSH_OPTS) $(SSH_USER)@$$server "\
		if command -v node &> /dev/null; then \
			echo '    [$$server] Node.js ì´ë¯¸ ì„¤ì¹˜ë¨: '\$$(node -v) '(npm: '\$$(npm -v)')'; \
		else \
			echo '    [$$server] Node.js ì„¤ì¹˜ ì¤‘...' && \
			curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - && \
			sudo apt-get install -y nodejs && \
			echo '    [$$server] Node.js ì„¤ì¹˜ ì™„ë£Œ: '\$$(node -v) '(npm: '\$$(npm -v)')'; \
		fi"; \
	echo "  ğŸ“ ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±..."; \
	ssh $(SSH_OPTS) $(SSH_USER)@$$server "mkdir -p $(DEPLOY_PATH)"; \
	echo "  ğŸ“¦ Standalone ë¹Œë“œ ë³µì‚¬..."; \
	rsync $(RSYNC_OPTS) --exclude='*.log' --exclude='.env*' --exclude="server.pid" --exclude='/package.json' .next/standalone/ $(SSH_USER)@$$server:$(DEPLOY_PATH)/; \
	echo "  ğŸ¨ Static íŒŒì¼ ë³µì‚¬..."; \
	rsync $(RSYNC_OPTS) .next/static $(SSH_USER)@$$server:$(DEPLOY_PATH)/.next/; \
	echo "  ğŸ–¼ï¸  Public íŒŒì¼ ë³µì‚¬..."; \
	rsync $(RSYNC_OPTS) public $(SSH_USER)@$$server:$(DEPLOY_PATH)/; \
	echo "  ğŸ”§ ì¬ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬..."; \
	rsync $(RSYNC_OPTS) restart.sh $(SSH_USER)@$$server:$(DEPLOY_PATH)/; \
	echo "  ğŸ”„ ì„œë²„ ì¬ì‹œì‘..."; \
	ssh $(SSH_OPTS) $(SSH_USER)@$$server "cd $(DEPLOY_PATH) && chmod +x restart.sh && ./restart.sh"; \
	echo "âœ… $$server ë°°í¬ ì™„ë£Œ!"; \
	echo ""
endef

# ê¸°ë³¸ ë°°í¬ (ì—¬ëŸ¬ ì„œë²„ ë³‘ë ¬ ë°°í¬)
deploy: check-pem build-local
	@echo "ğŸ“¦ ë°°í¬ ì‹œì‘ (ë³‘ë ¬)..."
	@if [ -z "$(SERVERS)" ]; then \
		echo "âŒ SERVERSê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."; \
		exit 1; \
	fi
	@echo "   Target servers: $(SERVERS)"
	@echo ""
	@pids=""; \
	for server in $(SERVERS); do \
		echo "  â†’ Starting deployment to $$server..."; \
		($(deploy_single_server) && \
		 echo "  âœ… $$server deployment completed" || \
		 echo "  âŒ $$server deployment failed") & \
		pids="$$pids $$!"; \
	done; \
	echo ""; \
	echo "â³ Waiting for all deployments to complete..."; \
	wait $$pids; \
	echo ""
	@echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"

# í”„ë¡œë•ì…˜ ì„œë²„ ë°°í¬ (ë³‘ë ¬)
deploy-prod: check-pem build-local
	@echo "ğŸ“¦ í”„ë¡œë•ì…˜ ì„œë²„ ë°°í¬ ì‹œì‘ (ë³‘ë ¬)..."
	@if [ -z "$(SERVERS)" ]; then \
		echo "âŒ SERVERSê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."; \
		echo "ğŸ’¡ ì‚¬ìš©ë²•: make deploy-prod DEPLOY_SERVERS=\"ip1 ip2 ip3\""; \
		exit 1; \
	fi
	@echo "   Target servers: $(SERVERS)"
	@echo ""
	@pids=""; \
	for server in $(SERVERS); do \
		echo "  â†’ Starting deployment to $$server..."; \
		($(deploy_single_server) && \
		 echo "  âœ… $$server deployment completed" || \
		 echo "  âŒ $$server deployment failed") & \
		pids="$$pids $$!"; \
	done; \
	echo ""; \
	echo "â³ Waiting for all deployments to complete..."; \
	wait $$pids; \
	echo ""
	@echo "ğŸ‰ í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ!"

# ê°œë°œ ì„œë²„ ë°°í¬ (ë³‘ë ¬)
deploy-dev: check-pem build-local
	@echo "ğŸ“¦ ê°œë°œ ì„œë²„ ë°°í¬ ì‹œì‘ (ë³‘ë ¬)..."
	@if [ -z "$(DEV_SERVER)" ]; then \
		echo "âŒ DEV_SERVERê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."; \
		echo "ğŸ’¡ ì‚¬ìš©ë²•: make deploy-dev DEV_SERVER=\"ip1 ip2 ip3\""; \
		exit 1; \
	fi
	@echo "   Target servers: $(DEV_SERVER)"
	@echo ""
	@pids=""; \
	for server in $(DEV_SERVER); do \
		echo "  â†’ Starting deployment to $$server..."; \
		($(deploy_single_server) && \
		 echo "  âœ… $$server deployment completed" || \
		 echo "  âŒ $$server deployment failed") & \
		pids="$$pids $$!"; \
	done; \
	echo ""; \
	echo "â³ Waiting for all deployments to complete..."; \
	wait $$pids; \
	echo ""
	@echo "ğŸ‰ ê°œë°œ ì„œë²„ ë°°í¬ ì™„ë£Œ!"

# ëª¨ë“  ì„œë²„ì— ë°°í¬ (DEPLOY_SERVERS + DEV_SERVER, ë³‘ë ¬)
deploy-all: check-pem build-local
	@echo "ğŸ“¦ ëª¨ë“  ì„œë²„ì— ë°°í¬ ì‹œì‘ (ë³‘ë ¬)..."
	@all_servers="$(DEPLOY_SERVERS) $(DEV_SERVER)"; \
	if [ -z "$$all_servers" ]; then \
		echo "âŒ ë°°í¬í•  ì„œë²„ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."; \
		echo "ğŸ’¡ DEPLOY_SERVERS ë˜ëŠ” DEV_SERVERë¥¼ ì„¤ì •í•˜ì„¸ìš”."; \
		exit 1; \
	fi; \
	echo "   Target servers: $$all_servers"; \
	echo ""; \
	pids=""; \
	for server in $$all_servers; do \
		echo "  â†’ Starting deployment to $$server..."; \
		($(deploy_single_server) && \
		 echo "  âœ… $$server deployment completed" || \
		 echo "  âŒ $$server deployment failed") & \
		pids="$$pids $$!"; \
	done; \
	echo ""; \
	echo "â³ Waiting for all deployments to complete..."; \
	wait $$pids; \
	echo ""
	@echo "ğŸ‰ ëª¨ë“  ì„œë²„ ë°°í¬ ì™„ë£Œ!"